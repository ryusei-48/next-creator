"use strict";(()=>{var e={};e.id=5848,e.ids=[5848],e.modules={53524:e=>{e.exports=require("@prisma/client")},67096:e=>{e.exports=require("bcrypt")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},73292:e=>{e.exports=require("fs/promises")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},72254:e=>{e.exports=require("node:buffer")},87561:e=>{e.exports=require("node:fs")},84492:e=>{e.exports=require("node:stream")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},81582:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>P,originalPathname:()=>b,requestAsyncStorage:()=>g,routeModule:()=>$,serverHooks:()=>v,staticGenerationAsyncStorage:()=>_,staticGenerationBailout:()=>y});var a={};r.r(a),r.d(a,{POST:()=>upload}),r(52676);var i=r(30813),s=r(19361),o=r(29474),u=r(6962),p=r(23284),n=r(53524),d=r(64961),l=r(73292),m=r(7408);let w=require("sharp");var c=r.n(w);let h=process.env.APP_URL,x=process.env.APP_ROOT_PATH,q=`${x}/public/media`,f=new n.PrismaClient;async function upload(e){let t=await (0,o.getServerSession)(u.Y),r=await e.formData(),a=r.get("upload");if(t&&a){let e=await a.arrayBuffer(),t=Buffer.from(e),r=await (0,d.pM)(t),i=(0,m.ET)("y"),s=(0,m.ET)("m"),o=(0,m.ET)("d"),u=`${q}/${i}/${s}/${o}`,n=`/media/${i}/${s}/${o}`,w=(0,m.O1)(15),x={urls:{}},$={paths:{}};if(process.umask(0),await (0,m.m3)(`${q}/${i}`)||await (0,l.mkdir)(`${q}/${i}`,"0755"),await (0,m.m3)(`${q}/${i}/${s}`)||await (0,l.mkdir)(`${q}/${i}/${s}`,"0755"),await (0,m.m3)(u)||await (0,l.mkdir)(u,"0755"),r&&r.mime.indexOf("image/")>=0){let e=c()(t,{animated:!0}),i=await e.metadata(),s=[];i.width&&i.width>=800&&s.push(800),i.width&&i.width>=1400&&s.push(1400),i.width&&i.width>=1920&&s.push(1920),i.width&&i.width>=2500&&s.push(2500),i.width&&i.width>=3e3&&s.push(3e3),i.width&&i.width>=3500&&s.push(3500),i.width&&s.push(i.width),await new Promise(t=>{for(let r of s){let s=e.resize(r);switch(i.format){case"jpg":s=s.jpeg({quality:80});break;case"png":s=s.png({compressionLevel:9,quality:80})}s.toFile(`${u}/${w}_w${r}_${a.name}`,()=>{t()}),$.paths[r]=n+`/${w}_w${r}_${a.name}`,x.urls[r]=h+`/api/media-stream?w=${r}&id=`}}),i.width&&($.paths.default=$.paths[i.width],x.urls.default=x.urls[i.width]);let o=await f.media.create({data:{name:a.name,mime:r.mime,url:$}});for(let[e,t]of Object.entries(x.urls))x.urls[e]=t+`${o.id}`;return p.Z.json(x,{status:200})}}return p.Z.json({error:{message:"アップロードに失敗しました。"}},{status:200})}let $=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/[lang]/api/upload/route",pathname:"/[lang]/api/upload",filename:"route",bundlePath:"app/[lang]/api/upload/route"},resolvedPagePath:"/var/www/next-creator/app/[lang]/api/upload/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:_,serverHooks:v,headerHooks:P,staticGenerationBailout:y}=$,b="/[lang]/api/upload/route"}};var t=require("../../../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),r=t.X(0,[8807,9059,7737,8813,3284,4961,6962,7408],()=>__webpack_exec__(81582));module.exports=r})();